#!/bin/bash

IFACE="venet0"

function _tc() {
  TOTALSRX=`vnstat --dumpdb -i $IFACE | grep 'totalrx;' | cut -d';' -f2`
  TOTALSTX=`vnstat --dumpdb -i $IFACE | grep 'totaltx;' | cut -d';' -f2`

  TOTALSRXMB=0
  TOTALSTXMB=0
  DL=0
  UL=0
  LIMIT=0

  for TOTALRX in $TOTALSRX
  do
    let 'TOTALSRXMB += TOTALRX'
  done

  for TOTALTX in $TOTALSTX
  do
    let 'TOTALSTXMB += TOTALTX'
  done

  DL=$(($TOTALSRXMB * 1024 * 1024))
  UL=$(($TOTALSTXMB * 1024 * 1024))

  echo 'DL' $DL
  echo 'UL' $UL

  HOSTNAME=$(hostname -s)
  VMID=${HOSTNAME//ct/}
  echo 'VMID' $VMID

  URL="https://my.dev.seedit4.me/api/vmtinfo/${VMID}/${UL}"
  echo 'URL' $URL

  LIMIT=$(curl -s -w "\n%{http_code}" "${URL}" | {
    read body
    echo $body
  })

  echo 'LIMIT' $LIMIT

  if (( UL > LIMIT )); then
    echo 'UNDER LIMIT'
  fi

  exit 0
}

_tc
